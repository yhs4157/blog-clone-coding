let Post,mongoose,Joi;_946‍.x([["checkObjectId",()=>checkObjectId],["write",()=>write],["list",()=>list],["read",()=>read],["remove",()=>remove],["replace",()=>replace],["update",()=>update]]);_946‍.w("../../models/post",[["default",["Post"],function(v){Post=v}]]);_946‍.w("mongoose",[["default",["mongoose"],function(v){mongoose=v}]]);_946‍.w("@hapi/joi",[["default",["Joi"],function(v){Joi=v}]]);
 


const {ObjectId} = mongoose.Types; 

       const checkObjectId = (ctx, next) => {
    const {id} = ctx.params; 
    if(!ObjectId.isValid(id)) {
        ctx.status = 400; 
        return;
    }
    return next(); 
};

// posts array init data
const posts = [
    {
        id: 1,
        title: "제목",
        body: "내용",
    },
];

/* 
post write 
POST /api/posts
{title, body}
*/
       const write = async ctx => {
// 검증과정 추가
    const schema = Joi.object().keys({
        title: Joi.string().required(),
        body: Joi.string().required(),
        tags: Joi.array()
            .items(Joi.string())
            .required(),
    });

//검증 후 실패 에러 처리
    const result = schema.validate(ctx.request.body);
    if(result.error) {
        ctx.status = 400; 
        ctx.body = result.error; 
        return;
    }
    
// 실제실행
    const {title, body, tags} = ctx.request.body; 
    const post = new Post({
        title, 
        body,
        tags,
    });
    try {
        await post.save(); 
        ctx.body = post; 
    } catch(e) {
        ctx.throw(500, e); 
    }
};

/*
post list read
GET /api/posts
*/
       const list = async ctx => {
    const page = parseInt(ctx.query.page || '1', 10);

    if(page < 1) {
        ctx.status = 400; 
        return;
    }

    try {
        const posts = await Post.find()
        .sort({_id: -1})
        .limit(10)
        .skip((page-1) * 10)
        .exec();

        const postCount = await Post.countDocuments().exec(); 
        ctx.set('Last-Page', Math.ceil(postCount/10)); 

        ctx.body = posts
        .map(post => post.toJSON())
        .map(post => ({
            ...post,
            body:
                post.body.length < 200 ? post.body : `${post.body.slice(0,200)}...`
        })); 
    } catch(e) {
        ctx.throw(500, e); 
    }
};

/*
id post read
GET /api/posts/:id
*/
       const read = async ctx => {
    const {id} = ctx.params; 
    try {
        const post = await Post.findById(id).exec(); 
        if(!post) {
            ctx.status = 404; 
            return;
        }
        ctx.body = post; 
    } catch(e) {
        ctx.throw(500, e); 
    }
};

/*
id post delete
DELETE /api/posts/:id
*/
       const remove = async ctx => {
    const {id} = ctx.params; 
    try {
        await Post.findByIdAndRemove(id).exec(); 
        ctx.status = 204; 
    } catch(e) {
        ctx.throw(500, e); 
    }
};

/*
post change
PUT /api/posts/:id
{title, body}
기본 내용을 새로 만듦. 
기존의 것이 날아감. 
62087258343f7c21770834af
*/
       const replace = ctx => {
    const {id} = ctx.params; 
    const index = posts.findIndex(element => element.id.toString() === id);
    
    if(index == -1) {
        ctx.status = 404; 
        ctx.body = {
            message: '포스트가 존재하지 않습니다.',
        };
        return;
    }
    
    posts[index] = {
        id, 
        ...ctx.request.body,
    };
    ctx.body = posts[index];
};

/*
post update
PATCH /api/posts/:id
{title, body}
기본 내용에 변경을 가함. 
변경이 없는 것들은 유지됨.
6208725c343f7c21770834b1 
*/
       const update = async ctx => {
    const {id} = ctx.params; 

    const schema = Joi.object().keys({
        title: Joi.string(),
        body: Joi.string(),
        tags: Joi.array()
            .items(Joi.string()),
    });

    const result = schema.validate(ctx.request.body); 
    if(result.error) {
        ctx.status = 400; 
        ctx.body = result.error; 
        return; 
    }

    try {
        const post = await Post.findByIdAndUpdate(id, ctx.request.body, {
            new: true,
        }).exec(); 
        if(!post) {
            ctx.status = 404; 
            return;
        }
        ctx.body = post; 
    } catch(e) {
        ctx.throw(500, e); 
    }
};
